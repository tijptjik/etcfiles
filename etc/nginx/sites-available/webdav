  map $remote_user $user_dir {
      default  "/mnt/storage/meta/appData/webdav/$remote_user";

      # Security: Reject usernames with path traversal attempts
      "~*(\.\.|\/|\\\\)"  "/dev/null/blocked";
  }

  server {
      listen 8443 ssl;
      http2 on;
      include /etc/nginx/conf.d/ssl_type.hk.conf; # Cloudflare Certs

      server_name sync.type.hk;

      # Increase limits
      client_max_body_size 4G;
      client_body_timeout 300s;

      # Security headers
      add_header X-Content-Type-Options nosniff always;
      add_header X-Frame-Options DENY always;

      # WebDAV root directory
      root /mnt/storage/meta/appData/webdav;

      # Enable WebDAV methods
      location / {
          # Use alias with $remote_user to create user-specific root
          alias $user_dir/;

          # Critical: Prevent directory traversal
          if ($user_dir = "/dev/null/blocked") {
              return 403 "Invalid username";
          }

          # Create intermediate directories
          create_full_put_path on;

          # WebDAV methods
          dav_methods PUT DELETE MKCOL COPY MOVE;
          dav_ext_methods PROPFIND OPTIONS LOCK UNLOCK;

          # Permissions
          dav_access user:rw group:rw all:rw;

          # Character encoding
          charset utf-8;

          # Autoindex off for security
          autoindex off;

          # Authentication
          auth_basic "WebDAV Restricted";
          auth_basic_user_file /etc/nginx/.htpasswd;

          # Add WebDAV headers
          add_header MS-Author-Via DAV always;
          add_header X-User-Path $user_dir always;  # Debug header

          # Handle OPTIONS
          if ($request_method = OPTIONS) {
              add_header DAV '1, 2' always;
              add_header Allow 'OPTIONS,GET,HEAD,POST,PUT,DELETE,PROPFIND,PROPPATCH,MKCOL,COPY,MOVE,LOCK,UNLOCK' always;
              add_header Content-Length 0 always;
              return 200;
          }
      }

      # Security: Deny access to parent directories
      location ~ /\.\. {
          deny all;
          return 403;
      }
  }
